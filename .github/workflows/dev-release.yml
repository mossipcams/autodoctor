name: Dev Release

on:
  push:
    branches:
      - dev

permissions:
  contents: write

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  dev-release:
    runs-on: ubuntu-latest
    needs: [ci]
    if: "!contains(github.event.head_commit.message, '[skip ci]')"

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Compute beta version
        id: version
        run: |
          BASE_VERSION=$(jq -r '.version' custom_components/autodoctor/manifest.json)

          # Find the highest existing beta number for this base version
          LAST_BETA=$(git tag --list "v${BASE_VERSION}-beta.*" \
            | grep -oP '(?<=beta\.)\d+$' \
            | sort -n | tail -1)
          NEXT_BETA=$(( ${LAST_BETA:-0} + 1 ))

          BETA_VERSION="${BASE_VERSION}-beta.${NEXT_BETA}"
          echo "version=${BETA_VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=v${BETA_VERSION}" >> "$GITHUB_OUTPUT"
          echo "Computed beta version: ${BETA_VERSION}"

      - name: Update manifest version for zip
        run: |
          jq --arg v "${{ steps.version.outputs.version }}" \
            '.version = $v' custom_components/autodoctor/manifest.json > tmp.json
          mv tmp.json custom_components/autodoctor/manifest.json

      - name: Create integration zip
        run: |
          cd custom_components
          zip -r ../autodoctor.zip autodoctor/

      - name: Create pre-release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.tag }}
          prerelease: true
          generate_release_notes: true
          files: autodoctor.zip
          target_commitish: dev
